# FMP ä»£ç å®¡æŸ¥æ±‡æ€»æŠ¥å‘Š

> å®¡æŸ¥æ—¶é—´ï¼š2026-02-16
> å®¡æŸ¥èŒƒå›´ï¼š167 ä¸ª Dart æ–‡ä»¶ï¼ŒæŠ½æ ·æ£€æŸ¥å…³é”®æ¨¡å—
> å®¡æŸ¥å›¢é˜Ÿï¼š5 ä¸ªä¸“é¡¹å®¡æŸ¥ Agentï¼ˆå†…å­˜å®‰å…¨ã€é”™è¯¯å¤„ç†ã€æ€§èƒ½ä¼˜åŒ–ã€é€»è¾‘ç»Ÿä¸€ã€UI ç»Ÿä¸€ï¼‰

## æ€»ä½“è¯„ä¼°

FMP é¡¹ç›®æ•´ä½“ä»£ç è´¨é‡**è‰¯å¥½**ï¼Œæ ¸å¿ƒéŸ³é¢‘ç³»ç»Ÿçš„æ¶æ„è®¾è®¡æˆç†Ÿï¼ˆç«æ€é˜²æŠ¤ã€é‡è¯•æœºåˆ¶ã€èµ„æºç®¡ç†ï¼‰ï¼ŒUI ç»„ä»¶åŒ–ç¨‹åº¦é«˜ï¼ˆç»Ÿä¸€å›¾ç‰‡åŠ è½½ã€Toast æœåŠ¡ã€ä¸»é¢˜ç³»ç»Ÿï¼‰ã€‚ä¸»è¦æ”¹è¿›ç©ºé—´é›†ä¸­åœ¨ï¼šMiniPlayer é«˜é¢‘ rebuildã€å…¨å±€é”™è¯¯å¤„ç†ç¼ºå¤±ã€ErrorDisplay ç»„ä»¶æœªè¢«å®é™…ä½¿ç”¨ã€ä»¥åŠéƒ¨åˆ†é¡µé¢èœå•é€‰é¡¹ä¸å®Œæ•´ã€‚

## é—®é¢˜ç»Ÿè®¡

| å®¡æŸ¥é¢†åŸŸ | ğŸ”´ ä¸¥é‡ | ğŸŸ¡ ä¸­ç­‰ | ğŸŸ¢ è‰¯å¥½å®è·µ | è¯¦ç»†æŠ¥å‘Š |
|----------|---------|---------|------------|---------|
| å†…å­˜å®‰å…¨ä¸èµ„æºç®¡ç† | 1 | 5 | 8 | [01_memory_safety.md](01_memory_safety.md) |
| é”™è¯¯å¤„ç†ä¸å´©æºƒé˜²æŠ¤ | 2 | 5 | 8 | [02_error_handling.md](02_error_handling.md) |
| æ€§èƒ½ä¼˜åŒ– | 2 | 6 | 10 | [03_performance.md](03_performance.md) |
| ä¸šåŠ¡é€»è¾‘ç»Ÿä¸€æ€§ | 3 | 6 | 8 | [04_logic_consistency.md](04_logic_consistency.md) |
| UI æ˜¾ç¤ºç»Ÿä¸€æ€§ | 3 | 5 | 7 | [05_ui_consistency.md](05_ui_consistency.md) |
| **åˆè®¡** | **11** | **27** | **41** | â€” |

---

## ğŸ”´ ä¸¥é‡é—®é¢˜æ±‡æ€»ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰

### P0 â€” ç¨³å®šæ€§ï¼ˆå¯èƒ½å¯¼è‡´å´©æºƒï¼‰

| # | é—®é¢˜ | æ¥æº | å½±å“ |
|---|------|------|------|
| 1 | **main.dart ç¼ºå°‘å…¨å±€é”™è¯¯å¤„ç†**ï¼ˆæ—  FlutterError.onError / runZonedGuardedï¼‰ | é”™è¯¯å¤„ç† | Release æ¨¡å¼ä¸‹æœªæ•è·å¼‚å¸¸å¯¼è‡´ç°å±ï¼Œæ— æ³•æ”¶é›†é”™è¯¯æ—¥å¿— |
| 2 | **AudioController.play()/pause() ç¼ºå°‘ try-catch** | é”™è¯¯å¤„ç† | media_kit åº•å±‚å¼‚å¸¸ç›´æ¥ä¼ æ’­åˆ° UIï¼Œå¯èƒ½å¯¼è‡´æœªå¤„ç†å¼‚å¸¸ |

### P1 â€” æ€§èƒ½ï¼ˆæ˜æ˜¾å½±å“ç”¨æˆ·ä½“éªŒï¼‰

| # | é—®é¢˜ | æ¥æº | å½±å“ |
|---|------|------|------|
| 3 | **MiniPlayer æ•´ä½“ watch audioControllerProvider** â€” æ¯ç§’ rebuild å¤šæ¬¡ | æ€§èƒ½ | å¸¸é©» Widgetï¼Œæ’­æ”¾æ—¶æŒç»­äº§ç”Ÿä¸å¿…è¦çš„ rebuild å¼€é”€ |
| 4 | **ExploreTrackTile / RankingTrackTile ä½¿ç”¨ ListTile + Row(leading)** | æ€§èƒ½+UI | æ»šåŠ¨æ—¶å¸ƒå±€æŠ–åŠ¨ï¼ˆlayout jitterï¼‰ï¼Œä¸”è¿åé¡¹ç›®è‡ªèº«è§„èŒƒ |

### P1 â€” åŠŸèƒ½ä¸€è‡´æ€§ï¼ˆå½±å“ç”¨æˆ·ä½“éªŒï¼‰

| # | é—®é¢˜ | æ¥æº | å½±å“ |
|---|------|------|------|
| 5 | **ErrorDisplay ç»„ä»¶å­˜åœ¨ä½†æ‰€æœ‰é¡µé¢éƒ½æœªä½¿ç”¨** â€” é”™è¯¯/ç©ºçŠ¶æ€æ ·å¼ä¸ç»Ÿä¸€ | UI ç»Ÿä¸€ | å›¾æ ‡å¤§å°(48 vs 64)ã€é—´è·ã€æŒ‰é’®æ ·å¼å„é¡µé¢ä¸ä¸€è‡´ |
| 6 | **æœç´¢é¡µæœ¬åœ°ç»“æœç¼ºå°‘ã€Œæ­Œè¯åŒ¹é…ã€èœå•** | é€»è¾‘ç»Ÿä¸€ | ç”¨æˆ·åœ¨æœç´¢é¡µã€Œæ­Œå•ä¸­ã€åŒºåŸŸæ— æ³•åŒ¹é…æ­Œè¯ |
| 7 | **é¦–é¡µå†å²è®°å½•ç¼ºå°‘ã€Œæ­Œè¯åŒ¹é…ã€èœå•** | é€»è¾‘ç»Ÿä¸€ | ç”¨æˆ·åœ¨é¦–é¡µå†å²åŒºåŸŸæ— æ³•åŒ¹é…æ­Œè¯ |
| 8 | **DownloadedCategoryPage ç¼ºå°‘æ¡Œé¢ç«¯å³é”®èœå•** | é€»è¾‘ç»Ÿä¸€ | æ¡Œé¢ç«¯ç”¨æˆ·åœ¨å·²ä¸‹è½½åˆ†ç±»é¡µæ— æ³•å³é”®æ“ä½œ |

### P1 â€” å†…å­˜å®‰å…¨

| # | é—®é¢˜ | æ¥æº | å½±å“ |
|---|------|------|------|
| 9 | **RankingCacheService Provider onDispose ä¸ºç©º** â€” Timer/ç›‘å¬ä¸æ¸…ç† | å†…å­˜å®‰å…¨ | Provider é‡å»ºæ—¶å¯èƒ½äº§ç”Ÿé‡å¤ç›‘å¬ |

---

## ğŸŸ¡ ä¸­ç­‰é—®é¢˜æ±‡æ€»ï¼ˆæŒ‰é¢†åŸŸåˆ†ç»„ï¼‰

### å†…å­˜ä¸èµ„æº
- FileExistsCache æ— å¤§å°é™åˆ¶ï¼ˆSet å¯èƒ½æ— é™å¢é•¿ï¼‰
- _MixPlaylistState.seenVideoIds æ— ä¸Šé™ä¿æŠ¤
- import_preview_page ä½¿ç”¨ ListView è€Œé ListView.builderï¼ˆå¤§æ­Œå•å¡é¡¿ï¼‰
- AudioController.dispose() ä¸­å¼‚æ­¥èµ„æºé‡Šæ”¾æœª await
- RadioRefreshService Provider ç¼ºå°‘ onDispose è¯´æ˜

### é”™è¯¯å¤„ç†
- BilibiliSource å¤šä¸ªæ–¹æ³•åªæ•è· DioExceptionï¼Œç¼ºå°‘é€šç”¨ catch
- _loadMoreMixTracks() ä¸­ YouTubeSource å®ä¾‹æœªé‡Šæ”¾
- Isolate ä¸‹è½½é”™è¯¯ä¿¡æ¯ä¸¢å¤±åŸå§‹ç±»å‹
- refreshAudioUrl() æ—  try-catch
- Provider .when() error å›è°ƒä¸¢å¼ƒé”™è¯¯è¯¦æƒ…

### æ€§èƒ½
- HomePage watch æ•´ä¸ª audioControllerProviderï¼ˆåº”æ‹†åˆ† sectionï¼‰
- FileExistsCache watch æ¨¡å¼å¯¼è‡´çº§è” rebuildï¼ˆç¼©ç•¥å›¾æ‰¹é‡é‡å»ºï¼‰
- LyricsDisplay å¯¹æ‰€æœ‰æ­Œè¯è¡Œåˆ›å»º TextPainterï¼ˆåº”é‡‡æ ·ï¼‰
- QueuePage _onPositionsChanged æ— èŠ‚æµ
- NowPlayingIndicator æ¯å¸§åˆ›å»º Widget å¯¹è±¡
- SearchPage build ä¸­åˆ›å»º allTracks åˆå¹¶åˆ—è¡¨

### é€»è¾‘ç»Ÿä¸€
- Toast æ¶ˆæ¯ i18n å‘½åç©ºé—´æ··ä¹±ï¼ˆExplorePage å€Ÿç”¨ searchPage çš„ keyï¼‰
- PlayHistoryPage æ’­æ”¾çŠ¶æ€åˆ¤æ–­ä½¿ç”¨ cid è€Œé pageNum
- DownloadedCategoryPage æ­Œæ›²èœå•ç¼ºå°‘ã€Œæ·»åŠ åˆ°æ­Œå•ã€å’Œã€Œæ­Œè¯åŒ¹é…ã€
- const Icon ä½¿ç”¨ä¸ä¸€è‡´
- mounted vs context.mounted æ··ç”¨

### UI ç»Ÿä¸€
- ç¡¬ç¼–ç  Colors.xxx æœªä½¿ç”¨ä¸»é¢˜è‰²ï¼ˆdownload_manager_page, settings_pageï¼‰
- ç¡¬ç¼–ç  BorderRadius æœªä½¿ç”¨ AppRadius å¸¸é‡
- èœå•é¡¹å†…éƒ¨å¸ƒå±€é£æ ¼ä¸ç»Ÿä¸€ï¼ˆListTile vs Rowï¼‰
- _HomePlaylistCard ä¸ _PlaylistCard çº¦ 200 è¡Œé‡å¤ä»£ç 
- ç¡¬ç¼–ç åŠ¨ç”»æ—¶é•¿æœªä½¿ç”¨ AnimationDurations å¸¸é‡

---

## ğŸŸ¢ å€¼å¾—è‚¯å®šçš„è‰¯å¥½å®è·µ

é¡¹ç›®ä¸­æœ‰å¾ˆå¤šå€¼å¾—è‚¯å®šçš„è®¾è®¡ï¼Œè¯´æ˜æ•´ä½“æ¶æ„æ„è¯†å¾ˆå¼ºï¼š

1. **éŸ³é¢‘ç³»ç»Ÿèµ„æºç®¡ç†** â€” MediaKitAudioService çš„ 13 ä¸ª StreamSubscription + 11 ä¸ª StreamController å…¨éƒ¨æ­£ç¡®æ¸…ç†
2. **media_kit å†…å­˜ä¼˜åŒ–** â€” bufferSize 4MBã€vid=noã€demuxer é™åˆ¶ï¼Œå°†å†…å­˜ä» 200+MB é™åˆ°çº¦ 5MB
3. **æ’­æ”¾ç«æ€é˜²æŠ¤** â€” _playRequestId + _isSuperseded + _LockWithId æœºåˆ¶ï¼Œæˆç†Ÿçš„å¹¶å‘æ§åˆ¶
4. **ç½‘ç»œé”™è¯¯é‡è¯•** â€” æŒ‡æ•°é€€é¿ + ç½‘ç»œæ¢å¤è‡ªåŠ¨é‡è¯• + æ‰‹åŠ¨é‡è¯•ï¼Œä¸‰å±‚ä¿éšœ
5. **YouTube Fallback** â€” audioOnly â†’ muxed â†’ HLS å¤šå±‚é™çº§
6. **å›¾ç‰‡åŠ è½½å®Œå…¨ç»Ÿä¸€** â€” é›¶ Image.network() ç›´æ¥è°ƒç”¨ï¼Œå…¨éƒ¨é€šè¿‡ TrackThumbnail/ImageLoadingService
7. **ç¼©ç•¥å›¾ URL ä¼˜åŒ–** â€” ä» ~700KB é™åˆ° ~20KBï¼Œæ˜¾è‘—èŠ‚çœå¸¦å®½å’Œå†…å­˜
8. **è¿›åº¦æ¡æ‹–åŠ¨ä¼˜åŒ–** â€” onChangeEnd æ‰ seekï¼Œé¿å…æ¶ˆæ¯é˜Ÿåˆ—æº¢å‡º
9. **è·¯ç”±æ— åŠ¨ç”»åˆ‡æ¢** â€” Shell å†… NoTransitionPageï¼Œé¿å… tab åˆ‡æ¢å¼€é”€
10. **ä¸‹è½½ç³»ç»Ÿ Isolate æ¸…ç†** â€” dispose ä¸­éå†æ‰€æœ‰ Isolate å¹¶ kill

---

## å»ºè®®ä¿®å¤ä¼˜å…ˆçº§

### ç¬¬ä¸€æ‰¹ï¼ˆé«˜ä¼˜å…ˆçº§ï¼Œå»ºè®®å°½å¿«ä¿®å¤ï¼‰
1. main.dart æ·»åŠ å…¨å±€é”™è¯¯å¤„ç†ï¼ˆFlutterError.onError + runZonedGuardedï¼‰
2. AudioController.play()/pause() æ·»åŠ  try-catch
3. MiniPlayer æ‹†åˆ†å­ Widget æˆ–ä½¿ç”¨ .select() ç²¾ç¡®ç›‘å¬
4. ExploreTrackTile / RankingTrackTile æ”¹ä¸º InkWell + Row è‡ªå®šä¹‰å¸ƒå±€
5. æ‰€æœ‰é¡µé¢é”™è¯¯/ç©ºçŠ¶æ€ç»Ÿä¸€ä½¿ç”¨ ErrorDisplay ç»„ä»¶

### ç¬¬äºŒæ‰¹ï¼ˆä¸­ä¼˜å…ˆçº§ï¼Œæ”¹å–„ä¸€è‡´æ€§ï¼‰
6. è¡¥å…¨ç¼ºå¤±çš„èœå•é¡¹ï¼ˆæœç´¢é¡µæ­Œè¯åŒ¹é…ã€é¦–é¡µå†å²æ­Œè¯åŒ¹é…ã€å·²ä¸‹è½½åˆ†ç±»å³é”®èœå•ï¼‰
7. RankingCacheService Provider onDispose æ·»åŠ æ¸…ç†é€»è¾‘
8. FileExistsCache ä½¿ç”¨ .select() å‡å°‘çº§è” rebuild
9. HomePage æ‹†åˆ† section ä¸ºç‹¬ç«‹ ConsumerWidget
10. ç»Ÿä¸€ Toast i18n å‘½åç©ºé—´
11. æ¶ˆé™¤ç¡¬ç¼–ç é¢œè‰²å’Œ BorderRadius

### ç¬¬ä¸‰æ‰¹ï¼ˆä½ä¼˜å…ˆçº§ï¼Œé”¦ä¸Šæ·»èŠ±ï¼‰
12. import_preview_page æ”¹ç”¨ ListView.builder
13. FileExistsCache / seenVideoIds æ·»åŠ å¤§å°é™åˆ¶
14. LyricsDisplay é‡‡æ ·ä¼˜åŒ–
15. æå– PlaylistCard å…±äº«æ“ä½œæ¶ˆé™¤é‡å¤ä»£ç 
16. ç»Ÿä¸€ const Icon / mounted ä½¿ç”¨
