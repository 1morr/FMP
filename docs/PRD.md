# Flutter Music Player (FMP) - 产品需求文档

> 版本: 1.0.0
> 创建日期: 2026-01-03
> 状态: 需求定义阶段

---

## 1. 项目概述

### 1.1 产品愿景

构建一个跨平台音乐播放器，支持从 Bilibili 和 YouTube 获取音源，提供统一的播放体验，支持离线播放、大规模播放队列管理和完整的音乐库功能。

### 1.2 目标用户

个人使用，用于整合不同平台的音乐资源到统一的播放体验中。

### 1.3 目标平台

| 优先级 | 平台 | 状态 |
|--------|------|------|
| MVP | Android | ✅ 必需 |
| MVP | Windows | ✅ 必需 |
| 未来 | iOS | 🔮 可选 |
| 未来 | Linux | 🔮 可选 |
| 未来 | macOS | 🔮 可选 |

---

## 2. 功能需求

### 2.1 音源集成

#### 2.1.1 支持的音源
- **Bilibili**: 视频/音频内容
- **YouTube**: 视频/音频内容

#### 2.1.2 音源特性
| 特性 | 说明 |
|------|------|
| 认证 | 无需登录，仅访问公开内容 |
| 音质 | 自动选择可用的最高音质 |
| 缓存 | 支持离线播放（下载缓存） |

### 2.2 页面结构

```
┌─────────────────────────────────────────┐
│                 App                      │
├─────────────────────────────────────────┤
│  ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐│
│  │首页 │ │搜索 │ │播放器│ │队列 │ │音乐库││
│  └─────┘ └─────┘ └─────┘ └─────┘ └─────┘│
│                    │                     │
│              ┌─────┴─────┐               │
│              │  设置页   │               │
│              └───────────┘               │
└─────────────────────────────────────────┘
```

#### 2.2.1 首页 (Home)
- **最近播放**: 显示最近播放的歌曲列表
- **推荐歌单**: 展示用户常听的本地歌单
- **快捷入口**: 快速访问常用功能
- **更新提醒**: 导入歌单的更新通知（可选显示）

#### 2.2.2 搜索页 (Search)
| 功能 | 说明 |
|------|------|
| 多源搜索 | 同时搜索所有音源 |
| 音源筛选 | 可选择特定音源进行过滤 |
| 搜索历史 | 保存并展示历史搜索记录 |
| 结果操作 | 直接播放 / 加入队列 / 添加到歌单 |

#### 2.2.3 播放器页 (Player)
| 功能 | 说明 |
|------|------|
| 播放控制 | 播放/暂停、上一首/下一首 |
| 进度控制 | 拖动进度条 + 快进快退按钮（±10秒） |
| 播放速度 | 支持 0.5x - 2.0x 调节 |
| 播放模式 | 顺序 / 单曲循环 / 列表循环 / 随机 |
| 断点续播 | 记住上次播放位置（精确到秒） |

#### 2.2.4 播放队列页 (Queue)
| 功能 | 说明 |
|------|------|
| 容量 | 支持上千首歌曲 |
| 持久化 | 重启应用后保持队列 |
| 拖拽排序 | 支持拖动调整顺序 |
| 随机打乱 | 一键打乱队列顺序 |
| 批量操作 | 移除单曲/批量移除 |

#### 2.2.5 音乐库页 (Library)
| 功能 | 说明 |
|------|------|
| 歌单数量 | 至少支持 50 个歌单 |
| 混合音源 | 同一歌单可添加不同音源的歌曲 |
| 自定义封面 | 支持设置歌单封面图片 |
| 导入歌单 | 从 B站收藏夹 URL / YouTube 播放列表 URL 导入 |
| 定时刷新 | 可配置导入歌单的自动刷新频率 |
| 同步删除 | 源歌单删除的歌曲本地同步删除 |
| 导出功能 | 支持导出歌单数据 |

#### 2.2.6 设置页 (Settings)
| 功能 | 说明 |
|------|------|
| 主题 | 预设深色/浅色主题 |
| 自定义配色 | 完整配色方案可修改（主色、背景、文字、卡片等） |
| 缓存管理 | 自定义缓存目录、设置缓存大小上限 |
| 下载管理 | 离线音频管理（无大小上限） |
| 导入刷新 | 配置导入歌单的刷新频率和通知 |
| 快捷键 | 自定义全局快捷键（桌面端） |

### 2.3 缓存与离线播放

#### 2.3.1 缓存系统
```
┌─────────────────────────────────────────┐
│              缓存层级                    │
├─────────────────────────────────────────┤
│  ┌─────────────────────────────────┐    │
│  │   流媒体缓存 (有大小上限)        │    │
│  │   - 自动清理 (LRU)              │    │
│  │   - 用户可设置上限              │    │
│  └─────────────────────────────────┘    │
│                                         │
│  ┌─────────────────────────────────┐    │
│  │   离线下载 (无大小上限)          │    │
│  │   - 用户主动下载                │    │
│  │   - 手动管理                    │    │
│  └─────────────────────────────────┘    │
└─────────────────────────────────────────┘
```

#### 2.3.2 下载管理界面
- 显示下载进度
- 暂停/继续下载
- 批量管理已下载内容
- 自定义存储目录（尤其 Windows 端）

### 2.4 桌面端特性 (Windows)

#### 2.4.1 系统托盘
| 功能 | 说明 |
|------|------|
| 托盘图标 | 显示应用图标 |
| 当前歌曲 | 显示正在播放的歌曲信息 |
| 右键菜单 | 播放控制、显示窗口、退出 |
| 左键点击 | 显示/聚焦窗口 |

#### 2.4.2 全局快捷键（用户可自定义）
| 默认快捷键 | 功能 |
|------------|------|
| `Space` 或自定义 | 播放/暂停 |
| `Ctrl+Right` 或自定义 | 下一首 |
| `Ctrl+Left` 或自定义 | 上一首 |
| `Ctrl+Up` 或自定义 | 音量增加 |
| `Ctrl+Down` 或自定义 | 音量减少 |
| `Ctrl+Shift+M` 或自定义 | 显示/隐藏窗口 |

#### 2.4.3 迷你播放器
- 在非播放页面底部显示迷你播放控制栏
- 显示当前歌曲信息
- 提供基本播放控制

### 2.5 移动端特性 (Android)

#### 2.5.1 后台播放
- 后台持续播放音乐
- 通知栏控制（播放/暂停、上下首）
- 显示当前歌曲信息和封面

### 2.6 错误处理

| 场景 | 处理方式 |
|------|----------|
| 网络错误 | Toast 提示后自动跳到下一首 |
| 音源失效 | 在歌单中灰色显示，附带失效原因文字 |
| 下载失败 | 重试机制 + 错误提示 |

---

## 3. 用户界面

### 3.1 响应式布局

```
┌─────────────────────────────────────────────────────────────┐
│                     响应式断点策略                           │
├───────────────┬─────────────────┬───────────────────────────┤
│   手机        │     平板         │        桌面              │
│   < 600dp     │   600-1200dp    │      > 1200dp            │
├───────────────┼─────────────────┼───────────────────────────┤
│ 底部导航栏    │ 底部/侧边导航    │ 侧边导航                 │
│ 单列布局      │ 双栏布局         │ 三栏布局                 │
│               │                  │ (导航/内容/播放器详情)   │
└───────────────┴─────────────────┴───────────────────────────┘
```

### 3.2 主题系统

#### 3.2.1 预设主题
- **浅色主题**: 白色背景为主
- **深色主题**: 深色背景为主

#### 3.2.2 自定义配色
用户可自定义的颜色项：
- 主色 (Primary Color)
- 次要色 (Secondary Color)
- 背景色 (Background Color)
- 表面色 (Surface Color)
- 文字色 (Text Colors)
- 卡片色 (Card Color)
- 强调色 (Accent Color)

### 3.3 迷你播放器

```
┌─────────────────────────────────────────────────────────────┐
│  🎵 歌曲名称 - 艺术家          ▶️ ⏭️  ━━━━━━━●━━━━ 2:30/4:00 │
└─────────────────────────────────────────────────────────────┘
```

---

## 4. 数据模型

### 4.1 核心实体

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│      Track      │     │    Playlist     │     │   PlayQueue     │
├─────────────────┤     ├─────────────────┤     ├─────────────────┤
│ id              │     │ id              │     │ id              │
│ title           │     │ name            │     │ tracks[]        │
│ artist          │     │ coverUrl        │     │ currentIndex    │
│ duration        │     │ tracks[]        │     │ playMode        │
│ sourceType      │────▶│ sourceUrl       │     │ lastPosition    │
│ sourceId        │     │ refreshInterval │     │ lastTrackId     │
│ thumbnailUrl    │     │ lastRefreshed   │     └─────────────────┘
│ audioUrl        │     │ notifyOnUpdate  │
│ isAvailable     │     │ createdAt       │
│ unavailableReason│    │ updatedAt       │
│ cachedPath      │     └─────────────────┘
│ downloadedPath  │
│ createdAt       │
└─────────────────┘

┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  SearchHistory  │     │    Settings     │     │   CacheConfig   │
├─────────────────┤     ├─────────────────┤     ├─────────────────┤
│ id              │     │ themeMode       │     │ cacheDir        │
│ query           │     │ customColors    │     │ maxCacheSize    │
│ timestamp       │     │ hotkeys         │     │ downloadDir     │
└─────────────────┘     │ defaultSource   │     └─────────────────┘
                        └─────────────────┘
```

### 4.2 音源类型枚举

```dart
enum SourceType {
  bilibili,
  youtube,
  // 未来可扩展
}
```

### 4.3 播放模式枚举

```dart
enum PlayMode {
  sequential,    // 顺序播放
  loop,          // 列表循环
  loopOne,       // 单曲循环
  shuffle,       // 随机播放
}
```

---

## 5. 未来扩展 (V2+)

以下功能在 MVP 中暂不实现，但架构设计时需预留扩展空间：

| 功能 | 优先级 | 说明 |
|------|--------|------|
| 歌词显示 | 中 | 从外部 API 获取歌词 |
| 音频可视化 | 低 | 频谱可视化效果 |
| 睡眠定时器 | 低 | 定时停止播放 |
| 云同步 | 中 | 跨设备同步播放队列和歌单 |
| 更多平台 | 中 | iOS、Linux、macOS |
| 更多音源 | 中 | SoundCloud、网易云等 |
| 均衡器 | 低 | 音频均衡调节 |

---

## 6. 非功能需求

### 6.1 性能要求

| 指标 | 要求 |
|------|------|
| 应用启动 | < 3 秒冷启动 |
| 播放启动 | < 2 秒从点击到播放 |
| 队列加载 | 1000+ 首歌曲流畅滚动 |
| 内存占用 | < 200MB 正常使用 |
| 搜索响应 | < 3 秒返回结果 |

### 6.2 可靠性

- 播放队列和歌单数据必须持久化
- 断点续播位置精确到秒
- 网络异常时优雅降级

### 6.3 安全性

- 本地数据加密存储（可选）
- 不存储第三方平台凭据
- 仅访问公开可用内容

---

## 7. 法律与合规

### 7.1 使用场景

本应用仅供**个人使用**，不对外发布。

### 7.2 免责声明

- 音频内容来自第三方平台
- 用户需自行遵守相关平台的服务条款
- 不鼓励用于任何商业用途或侵权行为

---

## 8. 附录

### 8.1 术语表

| 术语 | 说明 |
|------|------|
| Track | 单首歌曲/音频 |
| Playlist | 歌单 |
| Queue | 播放队列 |
| Source | 音源（Bilibili/YouTube） |
| Cache | 流媒体缓存（有上限，自动清理） |
| Download | 离线下载（无上限，手动管理） |

### 8.2 参考资源

- [Bilibili API](https://github.com/SocialSisterYi/bilibili-API-collect)
- [YouTube 音频提取](https://github.com/yt-dlp/yt-dlp)
- [Flutter 官方文档](https://flutter.dev/docs)
