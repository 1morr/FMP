# Bilibili åˆ†Pè§†é¢‘æ”¯æŒ - å®ç°è§„æ ¼

## æ¦‚è¿°

æ”¯æŒBilibiliå¤šåˆ†Pè§†é¢‘çš„æ’­æ”¾ã€å±•ç¤ºå’Œç®¡ç†ã€‚åˆ†Pè§†é¢‘åœ¨ç³»ç»Ÿä¸­è¢«è§†ä¸ºç‹¬ç«‹çš„å¯æ’­æ”¾å•å…ƒï¼Œå¯å•ç‹¬æ·»åŠ åˆ°é˜Ÿåˆ—ã€å‚ä¸éšæœºæ’­æ”¾ã€‚

---

## æ ¸å¿ƒè®¾è®¡å†³ç­–

| å†³ç­–é¡¹ | é€‰æ‹© |
|--------|------|
| æ•°æ®æ¨¡å‹ | æ¯ä¸ªåˆ†Pä½œä¸ºç‹¬ç«‹Trackå­˜å‚¨ï¼Œæ–°å¢cid/pageNumå­—æ®µ |
| åˆ†Pè·å–æ—¶æœº | å…¥åº“æ—¶è·å–ï¼ˆå¯¼å…¥æ­Œå•ï¼‰ï¼›æœç´¢é¡µç‚¹å‡»æ—¶æ‡’åŠ è½½ |
| UIäº¤äº’ | ç‚¹å‡»è§†é¢‘æ’­æ”¾ç¬¬ä¸€ä¸ªåˆ†Pï¼Œè‡ªåŠ¨å±•å¼€æ˜¾ç¤ºæ‰€æœ‰åˆ†P |
| æ­Œå•/é˜Ÿåˆ—æ˜¾ç¤º | æŒ‰çˆ¶è§†é¢‘åˆ†ç»„ï¼Œå¯å±•å¼€/æ”¶èµ· |
| éšæœºæ¨¡å¼ | åˆ†På•ç‹¬å‚ä¸éšæœº |
| æ ‡é¢˜æ˜¾ç¤º | åªæ˜¾ç¤ºåˆ†Pæ ‡é¢˜ï¼ˆpartå­—æ®µï¼‰ |
| å¯¼å…¥è¿›åº¦ | æ˜¾ç¤ºè¯¦ç»†è¿›åº¦ "æ­£åœ¨è·å–åˆ†Pä¿¡æ¯ (3/20)" |

---

## æ•°æ®æ¨¡å‹ä¿®æ”¹

### Track æ¨¡å‹æ‰©å±•

```dart
@collection
class Track {
  Id id = Isar.autoIncrement;
  
  // === ç°æœ‰å­—æ®µ ===
  late String sourceId;           // BVå·
  @Enumerated(EnumType.name)
  late SourceType sourceType;
  late String title;              // åˆ†Pæ—¶ä¸ºpartTitle
  String? artist;
  int? durationMs;
  String? thumbnailUrl;
  String? audioUrl;
  DateTime? audioUrlExpiry;
  bool isAvailable = true;
  String? unavailableReason;
  String? cachedPath;
  String? downloadedPath;
  @ignore
  int? viewCount;
  DateTime createdAt = DateTime.now();
  DateTime? updatedAt;
  
  // === æ–°å¢ï¼šåˆ†Pç›¸å…³å­—æ®µ ===
  int? cid;                       // Bilibili cidï¼ˆåˆ†På”¯ä¸€æ ‡è¯†ï¼‰
  int? pageNum;                   // åˆ†Påºå· (1, 2, 3...)ï¼Œnullè¡¨ç¤ºå•Pæˆ–æœªçŸ¥
  String? parentTitle;            // çˆ¶è§†é¢‘æ ‡é¢˜ï¼ˆç”¨äºåˆ†ç»„æ˜¾ç¤ºæ—¶çš„æ ‡é¢˜ï¼‰
  
  // === è®¡ç®—å±æ€§ ===
  
  /// æ˜¯å¦æ˜¯å¤šPè§†é¢‘ä¸­çš„ä¸€ä¸ªåˆ†P
  bool get isPartOfMultiPage => pageNum != null && pageNum! > 0;
  
  /// ç”¨äºåˆ†ç»„çš„keyï¼ˆåŒä¸€è§†é¢‘çš„åˆ†Pæœ‰ç›¸åŒçš„keyï¼‰
  String get groupKey => '${sourceType.name}:$sourceId';
  
  /// å”¯ä¸€æ ‡è¯†ï¼ˆåŒ…å«cidç”¨äºåŒºåˆ†åˆ†Pï¼‰
  String get uniqueKey => cid != null 
      ? '${sourceType.name}:$sourceId:$cid' 
      : '${sourceType.name}:$sourceId';
}
```

### VideoPage è¾…åŠ©ç±»ï¼ˆAPIå“åº”å’ŒUIå±•ç¤ºç”¨ï¼‰

```dart
/// è§†é¢‘åˆ†Pä¿¡æ¯ï¼ˆä¸å­˜å…¥æ•°æ®åº“ï¼Œç”¨äºAPIå“åº”å’Œä¸´æ—¶å±•ç¤ºï¼‰
class VideoPage {
  final int cid;
  final int page;           // åˆ†Påºå·ï¼Œä»1å¼€å§‹
  final String part;        // åˆ†Pæ ‡é¢˜
  final int duration;       // æ—¶é•¿ï¼ˆç§’ï¼‰
  
  const VideoPage({
    required this.cid,
    required this.page,
    required this.part,
    required this.duration,
  });
  
  /// è½¬æ¢ä¸ºTrackå¯¹è±¡
  Track toTrack(Track parent) => Track()
    ..sourceId = parent.sourceId
    ..sourceType = parent.sourceType
    ..title = part                    // åªæ˜¾ç¤ºåˆ†Pæ ‡é¢˜
    ..artist = parent.artist
    ..durationMs = duration * 1000
    ..thumbnailUrl = parent.thumbnailUrl
    ..cid = cid
    ..pageNum = page
    ..parentTitle = parent.title;     // ä¿å­˜çˆ¶è§†é¢‘æ ‡é¢˜ç”¨äºåˆ†ç»„
}
```

---

## API å±‚ä¿®æ”¹

### BilibiliSource æ‰©å±•

```dart
class BilibiliSource extends BaseSource {
  
  /// è·å–è§†é¢‘åˆ†Påˆ—è¡¨
  Future<List<VideoPage>> getVideoPages(String bvid) async {
    final response = await _dio.get(
      _viewApi,
      queryParameters: {'bvid': bvid},
    );
    _checkResponse(response.data);
    
    final pages = response.data['data']['pages'] as List;
    return pages.map((p) => VideoPage(
      cid: p['cid'] as int,
      page: p['page'] as int,
      part: p['part'] as String,
      duration: p['duration'] as int,
    )).toList();
  }
  
  /// è·å–æŒ‡å®šåˆ†Pçš„éŸ³é¢‘URLï¼ˆä¿®æ”¹ç°æœ‰æ–¹æ³•ï¼‰
  @override
  Future<String> getAudioUrl(String bvid, {int? cid}) async {
    // å¦‚æœæ²¡æœ‰æŒ‡å®šcidï¼Œå…ˆè·å–ç¬¬ä¸€ä¸ªåˆ†Pçš„cid
    if (cid == null) {
      final viewResponse = await _dio.get(
        _viewApi,
        queryParameters: {'bvid': bvid},
      );
      _checkResponse(viewResponse.data);
      cid = viewResponse.data['data']['cid'];
    }
    
    // ç”¨æŒ‡å®šcidè·å–æ’­æ”¾URL
    final playUrlResponse = await _dio.get(
      _playUrlApi,
      queryParameters: {
        'bvid': bvid,
        'cid': cid,
        'fnval': 16,
        'qn': 0,
        'fourk': 1,
      },
    );
    // ... ç°æœ‰çš„éŸ³é¢‘URLè§£æé€»è¾‘
  }
  
  /// è·å–Trackä¿¡æ¯ï¼ˆä¿®æ”¹ç°æœ‰æ–¹æ³•ï¼Œæ”¯æŒæŒ‡å®šåˆ†Pï¼‰
  @override
  Future<Track> getTrackInfo(String bvid, {int? cid, int? pageNum, String? partTitle}) async {
    // ... ç°æœ‰é€»è¾‘
    // å¦‚æœæŒ‡å®šäº†cidï¼Œä½¿ç”¨è¯¥cidè·å–éŸ³é¢‘URL
    // è®¾ç½®trackçš„cid, pageNum, parentTitleå­—æ®µ
  }
}
```

---

## åœºæ™¯æµç¨‹

### 1. æœç´¢é¡µé¢

```
ç”¨æˆ·æœç´¢ â†’ æ˜¾ç¤ºç»“æœåˆ—è¡¨ï¼ˆæ— åˆ†Pä¿¡æ¯ï¼‰
    â”‚
    â””â”€â†’ ç”¨æˆ·ç‚¹å‡»è§†é¢‘
            â”‚
            â”œâ”€â†’ å¼€å§‹æ’­æ”¾ç¬¬ä¸€ä¸ªåˆ†P
            â”‚
            â””â”€â†’ è·å–åˆ†Pä¿¡æ¯ â†’ å•P? â†’ ä¿æŒåŸæ ·
                           â”‚
                           â””â”€â†’ å¤šP? â†’ è‡ªåŠ¨å±•å¼€å­åˆ—è¡¨
                                      ç”¨æˆ·å¯ç‚¹å‡»å…¶ä»–åˆ†Påˆ‡æ¢
```

### 2. ä»URLå¯¼å…¥æ­Œå•

```
è¾“å…¥æ”¶è—å¤¹URL â†’ è§£æè·å–è§†é¢‘åˆ—è¡¨
    â”‚
    â””â”€â†’ éå†æ¯ä¸ªè§†é¢‘
            â”‚
            â”œâ”€â†’ è°ƒç”¨ getVideoPages(bvid)
            â”‚   æ˜¾ç¤ºè¿›åº¦: "æ­£åœ¨è·å–åˆ†Pä¿¡æ¯ (3/20)"
            â”‚
            â””â”€â†’ æ¯ä¸ªåˆ†Pè½¬ä¸ºç‹¬ç«‹Track â†’ å­˜å…¥æ­Œå•
```

### 3. æœç´¢ç»“æœæ·»åŠ åˆ°æ­Œå•

```
ç”¨æˆ·ç‚¹å‡»çˆ¶è§†é¢‘èœå• â†’ "æ·»åŠ åˆ°æ­Œå•"
    â”‚
    â””â”€â†’ è·å–åˆ†Pä¿¡æ¯ â†’ æ‰€æœ‰åˆ†På­˜ä¸ºç‹¬ç«‹Track â†’ å­˜å…¥æ­Œå•
```

### 4. æ­Œå•è¯¦æƒ…é¡µæ˜¾ç¤º

```
è¯»å–æ­Œå•ä¸­çš„Track â†’ æŒ‰ groupKey(sourceId) åˆ†ç»„
    â”‚
    â””â”€â†’ å¤šPè§†é¢‘æ˜¾ç¤ºä¸ºå¯æŠ˜å ç»„
        å•Pè§†é¢‘æ­£å¸¸æ˜¾ç¤º
```

---

## UI è®¾è®¡

### æœç´¢ç»“æœåˆ—è¡¨ï¼ˆå±•å¼€çŠ¶æ€ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ–¼ï¸ ã€åˆé›†ã€‘ç«æŸ´äººå¤§æˆ˜åŠ¨ç”»å¸ˆ                UPä¸»    12:30    â‹®  â”‚ â† çˆ¶è§†é¢‘
â”‚    â”œâ”€ â–¶ P1 å®£ä¼ çŸ­ç‰‡                        0:33   æ­£åœ¨æ’­æ”¾     â”‚ â† å½“å‰æ’­æ”¾
â”‚    â”œâ”€    P2 ç«æŸ´äººä¸åŠ¨ç”»å¸ˆ                 2:13           â‹®   â”‚ â† åˆ†Pèœå•
â”‚    â””â”€    P3 ç«æŸ´äººä¸åŠ¨ç”»å¸ˆ II              3:30           â‹®   â”‚
â”‚                                                                 â”‚
â”‚ ğŸ–¼ï¸ æ™®é€šå•Pè§†é¢‘                             UPä¸»    4:25    â‹®  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ­Œå•è¯¦æƒ…é¡µï¼ˆå¯æŠ˜å ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â–¼ ğŸ–¼ï¸ ã€åˆé›†ã€‘ç«æŸ´äººå¤§æˆ˜åŠ¨ç”»å¸ˆ              UPä¸»    (3P)    â‹®  â”‚ â† å·²å±•å¼€
â”‚    â”œâ”€ P1 å®£ä¼ çŸ­ç‰‡                          0:33           â‹®   â”‚
â”‚    â”œâ”€ P2 ç«æŸ´äººä¸åŠ¨ç”»å¸ˆ                    2:13           â‹®   â”‚
â”‚    â””â”€ P3 ç«æŸ´äººä¸åŠ¨ç”»å¸ˆ II                 3:30           â‹®   â”‚
â”‚                                                                 â”‚
â”‚ â–¶ ğŸ–¼ï¸ Flutteræ•™ç¨‹ç³»åˆ—                       UPä¸»    (5P)    â‹®  â”‚ â† å·²æŠ˜å 
â”‚                                                                 â”‚
â”‚   ğŸ–¼ï¸ æ™®é€šå•Pè§†é¢‘                           UPä¸»    4:25    â‹®  â”‚ â† æ— æŠ˜å å›¾æ ‡
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é˜Ÿåˆ—é¡µé¢ï¼ˆå¹³é“ºæ˜¾ç¤ºï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ’­æ”¾é˜Ÿåˆ— (22é¦–)                                         ğŸ—‘ï¸ æ¸…ç©º â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â–¶ ğŸ–¼ï¸ ç«æŸ´äººä¸åŠ¨ç”»å¸ˆ II              3:30    æ­£åœ¨æ’­æ”¾           â”‚ â† åªæ˜¾ç¤ºåˆ†Pæ ‡é¢˜
â”‚   ğŸ–¼ï¸ ç¯å¢ƒæ­å»º                       10:20                      â”‚
â”‚   ğŸ–¼ï¸ ç¬¬ä¸€ä¸ªApp                      15:30                      â”‚
â”‚   ğŸ–¼ï¸ æ™®é€šå•Pè§†é¢‘æ ‡é¢˜                 4:25                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## èœå•é€‰é¡¹

| èœå•é¡¹ | çˆ¶è§†é¢‘ | åˆ†P |
|--------|--------|-----|
| æ’­æ”¾ | âœ… æ’­æ”¾ç¬¬ä¸€ä¸ªåˆ†P | âœ… æ’­æ”¾è¯¥åˆ†P |
| ä¸‹ä¸€é¦–æ’­æ”¾ | âœ… æ·»åŠ æ‰€æœ‰åˆ†P | âœ… åªæ·»åŠ è¯¥åˆ†P |
| æ·»åŠ åˆ°é˜Ÿåˆ— | âœ… æ·»åŠ æ‰€æœ‰åˆ†P | âœ… åªæ·»åŠ è¯¥åˆ†P |
| æ·»åŠ åˆ°æ­Œå• | âœ… | âŒ |

---

## çŠ¶æ€ç®¡ç†

### SearchProvider / PlaylistDetailProvider æ–°å¢

```dart
/// å·²å±•å¼€çš„è§†é¢‘BVå·é›†åˆ
Set<String> expandedVideos = {};

/// å·²åŠ è½½åˆ†Pä¿¡æ¯çš„è§†é¢‘ç¼“å­˜ï¼ˆæœç´¢é¡µç”¨ï¼Œé¿å…é‡å¤è¯·æ±‚ï¼‰
Map<String, List<VideoPage>> loadedPages = {};

/// å±•å¼€/æŠ˜å è§†é¢‘
void toggleVideoExpansion(String bvid);

/// åŠ è½½è§†é¢‘åˆ†Pä¿¡æ¯
Future<List<VideoPage>> loadVideoPages(String bvid);
```

---

## é˜Ÿåˆ—ç³»ç»Ÿ

### Shuffle æ¨¡å¼

æ¯ä¸ªåˆ†Pä½œä¸ºç‹¬ç«‹Trackå‚ä¸éšæœºï¼š

```
åŸå§‹é˜Ÿåˆ—: [Video1-P1, Video1-P2, Video2, Video3-P1, Video3-P2, Video3-P3]
éšæœºå:   [Video3-P2, Video1-P1, Video2, Video3-P1, Video1-P2, Video3-P3]
```

### æ·»åŠ åˆ°é˜Ÿåˆ—

```dart
/// å°†è§†é¢‘ï¼ˆå¯èƒ½å«å¤šä¸ªåˆ†Pï¼‰æ·»åŠ åˆ°é˜Ÿåˆ—
Future<void> addVideoToQueue(Track parentTrack, List<VideoPage> pages) async {
  if (pages.length <= 1) {
    // å•Pè§†é¢‘ï¼Œç›´æ¥æ·»åŠ 
    await add(parentTrack);
  } else {
    // å¤šPè§†é¢‘ï¼Œæ‰€æœ‰åˆ†Pæ·»åŠ 
    final pageTracks = pages.map((p) => p.toTrack(parentTrack)).toList();
    await addAll(pageTracks);
  }
}
```

---

## å®ç°æ­¥éª¤

### Phase 1: æ•°æ®å±‚
1. ä¿®æ”¹ `Track` æ¨¡å‹ï¼Œæ·»åŠ  cid, pageNum, parentTitle å­—æ®µ
2. åˆ›å»º `VideoPage` ç±»
3. è¿è¡Œ `flutter pub run build_runner build --delete-conflicting-outputs`

### Phase 2: APIå±‚
4. `BilibiliSource` æ–°å¢ `getVideoPages()` æ–¹æ³•
5. ä¿®æ”¹ `getAudioUrl()` æ”¯æŒæŒ‡å®š cid å‚æ•°
6. ä¿®æ”¹ `getTrackInfo()` æ”¯æŒåˆ†Pä¿¡æ¯

### Phase 3: æœåŠ¡å±‚
7. ä¿®æ”¹å¯¼å…¥æ­Œå•é€»è¾‘ï¼Œè·å–åˆ†På¹¶æ˜¾ç¤ºè¿›åº¦
8. QueueManager ç¡®ä¿åˆ†Pæ­£ç¡®å‚ä¸ shuffle

### Phase 4: UIå±‚
9. åˆ›å»ºåˆ†Påˆ—è¡¨é¡¹ç»„ä»¶ `_PageTrackTile`
10. ä¿®æ”¹æœç´¢ç»“æœåˆ—è¡¨ï¼Œæ”¯æŒå±•å¼€/æ”¶èµ·
11. ä¿®æ”¹æ­Œå•è¯¦æƒ…é¡µï¼ŒæŒ‰çˆ¶è§†é¢‘åˆ†ç»„æ˜¾ç¤º
12. ä¿®æ”¹èœå•é€»è¾‘ï¼ˆçˆ¶è§†é¢‘ vs åˆ†Pï¼‰

---

## æ³¨æ„äº‹é¡¹

1. **å”¯ä¸€æ€§**: ä½¿ç”¨ `uniqueKey` (sourceId + cid) åˆ¤æ–­Trackå”¯ä¸€æ€§ï¼Œé¿å…é‡å¤æ·»åŠ 
2. **åˆ†ç»„æ˜¾ç¤º**: ä½¿ç”¨ `groupKey` (sourceId) å°†åŒä¸€è§†é¢‘çš„åˆ†Påˆ†ç»„
3. **æ ‡é¢˜æ˜¾ç¤º**: åˆ†Pçš„ `title` ç›´æ¥å­˜å‚¨ `part` å­—æ®µå€¼ï¼Œ`parentTitle` å­˜å‚¨çˆ¶è§†é¢‘æ ‡é¢˜
4. **ç¼“å­˜**: æœç´¢é¡µçš„åˆ†Pä¿¡æ¯ç¼“å­˜åœ¨å†…å­˜ä¸­ï¼Œé¿å…é‡å¤APIè°ƒç”¨
5. **è¿›åº¦æ˜¾ç¤º**: å¯¼å…¥æ­Œå•æ—¶æ˜¾ç¤º "æ­£åœ¨è·å–åˆ†Pä¿¡æ¯ (3/20)"
