# FMP ä»£ç ä¿®å¤è®¡åˆ’ï¼ˆ2026-01-14ï¼‰

## ä¿®å¤ä»»åŠ¡åˆ—è¡¨

| # | é—®é¢˜ | ä¼˜å…ˆçº§ | çŠ¶æ€ | æ¶‰åŠæ–‡ä»¶ |
|---|------|--------|------|---------|
| 1 | æ’­æ”¾æ—¶ä¸éªŒè¯æœ¬åœ°æ–‡ä»¶å­˜åœ¨æ€§ | ğŸ”´ é«˜ | âœ… å·²ä¿®å¤ | audio_provider.dart, queue_manager.dart |
| 2 | `_getDownloadBaseDir` å®ç°é‡å¤ | ğŸ”´ é«˜ | âœ… å·²ä¿®å¤ | download_path_utils.dart, 4ä¸ªæœåŠ¡æ–‡ä»¶ |
| 3 | `cachedPath` å­—æ®µæœªä½¿ç”¨ | ğŸŸ¡ ä¸­ | âœ… å·²ä¿®å¤ | track.dart, audio_provider.dart, queue_manager.dart |
| 4 | `localCoverPath` åŒæ­¥ I/O | ğŸŸ¡ ä¸­ | âœ… å·²ä¿®å¤ | track_extensions.dart |
| 5 | æ•°æ®æºä¸ä¸€è‡´ | ğŸŸ¢ ä½ | âœ… å¯æ¥å— | - |
| 6 | "æ­£åœ¨æ’­æ”¾"åˆ¤æ–­ä¸ä¸€è‡´ | ğŸŸ¢ ä½ | âœ… å·²ä¿®å¤ | downloaded_category_page.dart |

---

## ä¿®å¤ 1ï¼šæ’­æ”¾æ—¶éªŒè¯æœ¬åœ°æ–‡ä»¶å­˜åœ¨æ€§

### é—®é¢˜æè¿°
`track.firstDownloadPath` åªè¿”å› `downloadPaths[0]`ï¼Œä¸æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å®é™…å­˜åœ¨ã€‚å¦‚æœç”¨æˆ·æ‰‹åŠ¨åˆ é™¤äº†æ–‡ä»¶ï¼Œä¼šå¯¼è‡´æ’­æ”¾å¤±è´¥ã€‚

### ä¿®å¤æ–¹æ¡ˆ
åœ¨ `DownloadStatusCache` ä¸­æ·»åŠ åŒæ­¥æ–¹æ³•ï¼Œéå†æ‰€æœ‰è·¯å¾„æ‰¾åˆ°ç¬¬ä¸€ä¸ªå­˜åœ¨çš„æ–‡ä»¶ã€‚

### ä¿®æ”¹æ–‡ä»¶

#### 1. `lib/providers/download/download_status_cache.dart`
å·²æœ‰ `getFirstExistingPathSync()` æ–¹æ³•ï¼Œä½†å®ƒä¸æ›´æ–°ç¼“å­˜ã€‚éœ€è¦ç¡®ä¿åœ¨æ’­æ”¾æ—¶æ­£ç¡®ä½¿ç”¨ã€‚

#### 2. `lib/services/audio/audio_provider.dart`

**ä¿®æ”¹ä½ç½®**: `_playTrack()` æ–¹æ³•ï¼ˆçº¦ 843 è¡Œï¼‰

```dart
// æ—§ä»£ç 
final url = trackWithUrl.firstDownloadPath ??
            trackWithUrl.cachedPath ??
            trackWithUrl.audioUrl;

if (trackWithUrl.firstDownloadPath != null || trackWithUrl.cachedPath != null) {
  await _audioService.playFile(url);
}

// æ–°ä»£ç 
String? localPath;
// éå†æ‰€æœ‰ä¸‹è½½è·¯å¾„ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªå­˜åœ¨çš„æ–‡ä»¶
for (final path in trackWithUrl.downloadPaths) {
  if (await File(path).exists()) {
    localPath = path;
    break;
  }
}

final url = localPath ?? trackWithUrl.audioUrl;

if (localPath != null) {
  await _audioService.playFile(url!);
} else {
  // ç½‘ç»œæ’­æ”¾
  final headers = _getHeadersForTrack(trackWithUrl);
  await _audioService.playUrl(url!, headers: headers);
}
```

#### 3. `lib/services/audio/audio_provider.dart`

**ä¿®æ”¹ä½ç½®**: `playTemporary()` æ–¹æ³•ï¼ˆçº¦ 387 è¡Œï¼‰å’Œ `_restoreSavedState()` æ–¹æ³•ï¼ˆçº¦ 448 è¡Œï¼‰

åº”ç”¨ç›¸åŒçš„ä¿®æ”¹æ¨¡å¼ã€‚

#### 4. `lib/services/audio/queue_manager.dart`

**ä¿®æ”¹ä½ç½®**: `_prefetchTrack()` æ–¹æ³•ï¼ˆçº¦ 612 è¡Œï¼‰å’Œ `ensureAudioUrl()` æ–¹æ³•ï¼ˆçº¦ 710 è¡Œï¼‰

åº”ç”¨ç›¸åŒçš„ä¿®æ”¹æ¨¡å¼ã€‚

---

## ä¿®å¤ 2ï¼šç»Ÿä¸€ `_getDownloadBaseDir` å®ç°

### é—®é¢˜æè¿°
4 ä¸ªæ–‡ä»¶ä¸­æœ‰å‡ ä¹ç›¸åŒçš„è·¯å¾„è·å–ä»£ç ï¼Œè¿å DRY åŸåˆ™ã€‚

### ä¿®å¤æ–¹æ¡ˆ
åœ¨ `DownloadPathUtils` ä¸­æ·»åŠ é™æ€æ–¹æ³•ï¼Œå…¶ä»–æ–‡ä»¶è°ƒç”¨è¯¥æ–¹æ³•ã€‚

### ä¿®æ”¹æ–‡ä»¶

#### 1. `lib/services/download/download_path_utils.dart`

**æ–°å¢æ–¹æ³•**:
```dart
import 'dart:io';
import 'package:path/path.dart' as p;
import 'package:path_provider/path_provider.dart';
import '../../data/repositories/settings_repository.dart';

class DownloadPathUtils {
  // ... ç°æœ‰ä»£ç  ...

  /// è·å–é»˜è®¤ä¸‹è½½åŸºç¡€ç›®å½•
  /// 
  /// ä¼˜å…ˆçº§ï¼š
  /// 1. ç”¨æˆ·è‡ªå®šä¹‰ç›®å½•ï¼ˆsettings.customDownloadDirï¼‰
  /// 2. Android: /storage/emulated/0/Music/FMP
  /// 3. Windows: C:\Users\xxx\Documents\FMP
  static Future<String> getDefaultBaseDir(SettingsRepository settingsRepo) async {
    final settings = await settingsRepo.get();
    
    // 1. ä¼˜å…ˆä½¿ç”¨è‡ªå®šä¹‰ç›®å½•
    if (settings.customDownloadDir != null && settings.customDownloadDir!.isNotEmpty) {
      return settings.customDownloadDir!;
    }
    
    // 2. Android: å¤–éƒ¨å­˜å‚¨ Music ç›®å½•
    if (Platform.isAndroid) {
      final extDir = await getExternalStorageDirectory();
      if (extDir != null) {
        final musicDir = p.join(extDir.parent.parent.parent.parent.path, 'Music', 'FMP');
        return musicDir;
      }
      final appDir = await getApplicationDocumentsDirectory();
      return p.join(appDir.path, 'FMP');
    }
    
    // 3. Windows/å…¶ä»–: Documents ç›®å½•
    final docsDir = await getApplicationDocumentsDirectory();
    return p.join(docsDir.path, 'FMP');
  }
}
```

#### 2. `lib/services/download/download_service.dart`

**åˆ é™¤**: `_getDefaultDownloadDir()` æ–¹æ³•ï¼ˆ596-616 è¡Œï¼‰

**ä¿®æ”¹**: æ‰€æœ‰è°ƒç”¨æ”¹ä¸º `DownloadPathUtils.getDefaultBaseDir(_settingsRepository)`

#### 3. `lib/services/import/import_service.dart`

**åˆ é™¤**: `_getDownloadBaseDir()` æ–¹æ³•ï¼ˆ489-509 è¡Œï¼‰

**ä¿®æ”¹**: æ‰€æœ‰è°ƒç”¨æ”¹ä¸º `DownloadPathUtils.getDefaultBaseDir(_settingsRepository)`

#### 4. `lib/services/library/playlist_service.dart`

**åˆ é™¤**: `_getDownloadBaseDir()` æ–¹æ³•ï¼ˆ247-267 è¡Œï¼‰

**ä¿®æ”¹**: æ‰€æœ‰è°ƒç”¨æ”¹ä¸º `DownloadPathUtils.getDefaultBaseDir(_settingsRepository)`

#### 5. `lib/services/library/playlist_folder_migrator.dart`

**åˆ é™¤**: `_getDefaultDownloadDir()` æ–¹æ³•ï¼ˆ197-210 è¡Œï¼‰

**æ³¨æ„**: æ­¤ç±»éœ€è¦æ·»åŠ  `SettingsRepository` ä¾èµ–ï¼Œæˆ–è€…åˆ›å»ºä¸€ä¸ªä¸éœ€è¦ settings çš„ç®€åŒ–ç‰ˆæœ¬ã€‚

---

## ä¿®å¤ 3ï¼šç§»é™¤ `cachedPath` å­—æ®µ

### é—®é¢˜æè¿°
`cachedPath` å­—æ®µåœ¨ä»£ç ä¸­è¢«è¯»å–ä½†ä»æœªè¢«è®¾ç½®ï¼Œå§‹ç»ˆä¸º `null`ã€‚

### ä¿®å¤æ–¹æ¡ˆ
å®Œå…¨ç§»é™¤è¯¥å­—æ®µåŠå…¶æ‰€æœ‰å¼•ç”¨ã€‚

### ä¿®æ”¹æ–‡ä»¶

#### 1. `lib/data/models/track.dart`

**åˆ é™¤å­—æ®µ**:
```dart
// åˆ é™¤è¿™ä¸€è¡Œ
String? cachedPath;
```

#### 2. `lib/services/audio/audio_provider.dart`

**ä¿®æ”¹ä½ç½®**: å¤šå¤„ä½¿ç”¨ `track.cachedPath`

æœç´¢å¹¶åˆ é™¤æ‰€æœ‰ `cachedPath` å¼•ç”¨ï¼š
- `_playTrack()`: `trackWithUrl.cachedPath ??` 
- `playTemporary()`: `trackWithUrl.cachedPath ??`
- `_restoreSavedState()`: `trackWithUrl.cachedPath ??`
- `_prepareCurrentTrack()`: `trackWithUrl.cachedPath ??`

#### 3. `lib/services/audio/queue_manager.dart`

**ä¿®æ”¹ä½ç½®**: å¤šå¤„ä½¿ç”¨ `track.cachedPath`

æœç´¢å¹¶åˆ é™¤æ‰€æœ‰ `cachedPath` å¼•ç”¨ï¼š
- `_prefetchTrack()`: `track.cachedPath ??`
- `ensureAudioUrl()`: `track.cachedPath ??`

#### 4. è¿è¡Œ `build_runner`

ç”±äºä¿®æ”¹äº† Isar æ¨¡å‹ï¼Œéœ€è¦é‡æ–°ç”Ÿæˆï¼š
```bash
flutter pub run build_runner build --delete-conflicting-outputs
```

---

## ä¿®å¤ 4ï¼š`localCoverPath` åŒæ­¥ I/O

### é—®é¢˜æè¿°
`localCoverPath` getter ä¸­ä½¿ç”¨ `File.existsSync()` ä¼šé˜»å¡ UI çº¿ç¨‹ã€‚

### å»ºè®®æ–¹æ¡ˆï¼šç§»é™¤å­˜åœ¨æ€§æ£€æŸ¥

**ç†ç”±**ï¼š
1. `ImageLoadingService.loadImage()` å·²ç»å¤„ç†äº†æœ¬åœ°æ–‡ä»¶ä¸å­˜åœ¨çš„æƒ…å†µ
2. `LocalImageCache.getLocalImage()` å†…éƒ¨ä¼šæ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
3. å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œä¼šè‡ªåŠ¨å›é€€åˆ°ç½‘ç»œå›¾ç‰‡
4. æ— éœ€åœ¨ getter ä¸­é‡å¤æ£€æŸ¥

### ä¿®æ”¹æ–‡ä»¶

#### `lib/core/extensions/track_extensions.dart`

**æ—§ä»£ç **:
```dart
String? get localCoverPath {
  if (firstDownloadPath == null) return null;
  final dir = Directory(firstDownloadPath!).parent;
  final coverPath = '${dir.path}/cover.jpg';
  return File(coverPath).existsSync() ? coverPath : null;  // åŒæ­¥ I/O
}
```

**æ–°ä»£ç **:
```dart
/// è·å–æœ¬åœ°å°é¢è·¯å¾„ï¼ˆåŸºäºç¬¬ä¸€ä¸ªä¸‹è½½è·¯å¾„è®¡ç®—ï¼‰
/// 
/// æ³¨æ„ï¼šæ­¤æ–¹æ³•ä¸æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œç”± ImageLoadingService å¤„ç†å›é€€é€»è¾‘
String? get localCoverPath {
  if (firstDownloadPath == null) return null;
  final dir = Directory(firstDownloadPath!).parent;
  return '${dir.path}/cover.jpg';
}
```

**å¯é€‰ä¼˜åŒ–**ï¼šå¦‚æœéœ€è¦æ£€æŸ¥å¤šä¸ªä¸‹è½½è·¯å¾„çš„å°é¢ï¼š
```dart
/// è·å–æ‰€æœ‰å¯èƒ½çš„æœ¬åœ°å°é¢è·¯å¾„
List<String> get possibleCoverPaths {
  return downloadPaths.map((path) {
    final dir = Directory(path).parent;
    return '${dir.path}/cover.jpg';
  }).toList();
}
```

---

## ä¿®å¤ 5ï¼šæ•°æ®æºä¸ä¸€è‡´

### çŠ¶æ€ï¼šâœ… å¯æ¥å—

**åŸå› **ï¼š
- æ­Œå•é¡µé¢ä½¿ç”¨æ•°æ®åº“æ˜¯æ­£ç¡®çš„ï¼ˆéœ€è¦æ˜¾ç¤ºæ­Œå•å†…å®¹ï¼‰
- å·²ä¸‹è½½é¡µé¢ä½¿ç”¨æ–‡ä»¶æ‰«ææ˜¯æ­£ç¡®çš„ï¼ˆå³ä½¿æ•°æ®åº“æŸåä¹Ÿèƒ½è®¿é—®æ–‡ä»¶ï¼‰
- ä¸¤è€…èŒè´£ä¸åŒï¼Œä¸éœ€è¦ç»Ÿä¸€

---

## ä¿®å¤ 6ï¼šç»Ÿä¸€"æ­£åœ¨æ’­æ”¾"åˆ¤æ–­æ–¹å¼

### é—®é¢˜æè¿°
ä¸åŒé¡µé¢ä½¿ç”¨ä¸åŒçš„æ–¹å¼åˆ¤æ–­å½“å‰æ­Œæ›²æ˜¯å¦æ­£åœ¨æ’­æ”¾ã€‚

### ä¿®å¤æ–¹æ¡ˆ
ç»Ÿä¸€ä½¿ç”¨ `sourceId + pageNum` æ¯”è¾ƒï¼Œå› ä¸ºè¿™æ˜¯æœ€å¯é çš„æ ‡è¯†æ–¹å¼ã€‚

### ä¿®æ”¹æ–‡ä»¶

#### `lib/ui/pages/library/downloaded_category_page.dart`

**ä¿®æ”¹ä½ç½®**: çº¦ 602 è¡Œ

**æ—§ä»£ç **:
```dart
final isPlaying = currentTrack?.firstDownloadPath == track.firstDownloadPath;
```

**æ–°ä»£ç **:
```dart
final isPlaying = currentTrack != null &&
    currentTrack.sourceId == track.sourceId &&
    currentTrack.pageNum == track.pageNum;
```

---

## æ‰§è¡Œé¡ºåº

å»ºè®®æŒ‰ä»¥ä¸‹é¡ºåºæ‰§è¡Œä¿®å¤ï¼š

1. **ä¿®å¤ 3**ï¼ˆç§»é™¤ cachedPathï¼‰- å…ˆæ¸…ç†æ— ç”¨ä»£ç ï¼Œå‡å°‘åç»­ä¿®æ”¹é‡
2. **ä¿®å¤ 2**ï¼ˆç»Ÿä¸€ getDownloadBaseDirï¼‰- é‡æ„åŸºç¡€è®¾æ–½
3. **ä¿®å¤ 1**ï¼ˆéªŒè¯æ–‡ä»¶å­˜åœ¨æ€§ï¼‰- æ ¸å¿ƒåŠŸèƒ½ä¿®å¤
4. **ä¿®å¤ 4**ï¼ˆlocalCoverPathï¼‰- æ€§èƒ½ä¼˜åŒ–
5. **ä¿®å¤ 6**ï¼ˆç»Ÿä¸€æ’­æ”¾åˆ¤æ–­ï¼‰- UI ä¸€è‡´æ€§

## æµ‹è¯•è¦ç‚¹

### ä¿®å¤ 1 æµ‹è¯•
- [ ] æ‰‹åŠ¨åˆ é™¤å·²ä¸‹è½½æ–‡ä»¶åæ’­æ”¾ï¼Œåº”å›é€€åˆ°ç½‘ç»œæµ
- [ ] å¤šä¸ªæ­Œå•éƒ½ä¸‹è½½äº†åŒä¸€é¦–æ­Œï¼Œåˆ é™¤ä¸€ä¸ªååº”ä½¿ç”¨å¦ä¸€ä¸ª

### ä¿®å¤ 2 æµ‹è¯•
- [ ] å¯¼å…¥æ­Œå•æ—¶è·¯å¾„è®¡ç®—æ­£ç¡®
- [ ] ä¸‹è½½æ—¶è·¯å¾„ä¸å¯¼å…¥æ—¶ä¸€è‡´
- [ ] è‡ªå®šä¹‰ä¸‹è½½ç›®å½•ç”Ÿæ•ˆ

### ä¿®å¤ 3 æµ‹è¯•
- [ ] ç¼–è¯‘é€šè¿‡
- [ ] æ’­æ”¾åŠŸèƒ½æ­£å¸¸

### ä¿®å¤ 4 æµ‹è¯•
- [ ] å›¾ç‰‡åŠ è½½æ­£å¸¸
- [ ] æœ¬åœ°å°é¢ä¸å­˜åœ¨æ—¶æ˜¾ç¤ºç½‘ç»œå°é¢

### ä¿®å¤ 6 æµ‹è¯•
- [ ] å·²ä¸‹è½½é¡µé¢æ­£ç¡®é«˜äº®å½“å‰æ’­æ”¾æ­Œæ›²
